import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

session = requests.Session()
retries = Retry(total=3, backoff_factor=1, status_forcelist=[429, 500, 502, 503, 504])
session.mount('http://', HTTPAdapter(max_retries=retries))

# Thay bằng token mới lấy từ giao diện
access_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDI4YTlkODM0ZDZiNTQwYmU3ODI1OSIsInJvbGVJZCI6MiwiaWF0IjoxNzQ2NzgwMDQ1LCJleHAiOjE3NDY3ODA5NDV9.-vNfkuI-8Wi_k2SEaHJpXheYraptYx5T0CnOQHkOE6U'
cookies = {'accessToken': access_token}
headers = {'Authorization': f'Bearer {access_token}'}

book_ids = ['680163f63d04db8d6d7d4607', '680163f63d04db8d6d7d4610']
quantities = [25, 23]

for book_id, qty in zip(book_ids, quantities):
    data = {'bookId': book_id, 'quantity': qty}
    for _ in range(5):
        try:
            response = session.post(
                'http://172.16.30.234:4000/borrows',
                data=data,
                cookies=cookies,
                headers=headers,
                timeout=10,
                allow_redirects=True
            )
            print(f'Mượn sách {book_id}: {response.status_code}, Location: {response.headers.get("Location")}')
            if "Đăng nhập" in response.text or response.status_code != 200:
                print(f'Response Content: {response.text}')
            else:
                print(f'Response: {response.text[:200]}...')
        except requests.exceptions.RequestException as e:
            print(f'Lỗi khi mượn sách {book_id}: {e}')